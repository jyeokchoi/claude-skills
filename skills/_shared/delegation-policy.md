# 위임 정책

메인 에이전트의 컨텍스트 윈도우를 보호하기 위한 작업 위임 규칙.

## 위임 기준

다음 작업은 반드시 서브에이전트(`Task()`)로 위임한다:

| 작업 | 위임 역할 | 이유 |
|------|----------|------|
| 파일 3개 이상 읽기/분석 | `explore` 또는 목적에 맞는 역할 | 파일 내용이 메인 컨텍스트를 점유 |
| diff 분석 (50줄+) | `architect`, `quality-reviewer` | 대량 diff가 컨텍스트 소모 |
| 코드 리뷰 | `code-reviewer`, `quality-reviewer` | 리뷰 결과만 메인에 필요 |
| 구현/리팩토링 | `executor`, `deep-executor` | 구현 과정 자체가 컨텍스트 불필요 |
| 검증/테스트 분석 | `verifier`, `test-engineer` | 검증 결과만 메인에 필요 |
| 아키텍처 평가 | `architect` | 분석 과정이 메인 컨텍스트 불필요 |
| 디버깅/근본원인 분석 | `debugger` | 디버깅 과정이 메인 컨텍스트 불필요 |
| 계획/설계 비판 | `critic` | 비판 과정이 메인 컨텍스트 불필요 |
| UI/UX 설계 | `designer` | 설계 과정이 메인 컨텍스트 불필요 |
| 프론트엔드 구현 | `executor` 또는 외부 CLI (gemini) | 구현 과정이 메인 컨텍스트 불필요 |

## 메인 에이전트 역할

메인 에이전트는 다음만 수행한다:

- **오케스트레이션**: 어떤 에이전트를 어떤 순서로 호출할지 결정
- **결과 통합**: 서브에이전트 결과를 요약하여 다음 단계에 전달
- **사용자 소통**: 진행 상황 보고, 질문, 승인 요청
- **상태 관리**: 워크로그 업데이트, phase 전환, 오케스트레이션 상태

## 위임 방법

### 에이전트 선택

`_shared/agent-routing.md`의 라우팅 테이블에서 역할을 조회한다. subagent_type을 직접 하드코딩하지 않는다.

### 컨텍스트 포함 원칙

서브에이전트 프롬프트에 필요한 컨텍스트를 **직접 포함**한다:

```
Task(subagent_type="...", model="...", prompt="""
[분석 대상 코드]
{file_contents}

[작업 지시]
위 코드를 분석하여 ...
""")
```

- **작은 컨텍스트** (<3000줄): 파일 내용을 프롬프트에 직접 포함
- **큰 컨텍스트** (≥3000줄): 요약 + 워크트리 경로 제공, Read tool 사용 허용

### 병렬 실행

독립적인 작업은 반드시 동시에 호출한다:

```
# 좋은 예: 3개 에이전트 동시 발사
Task(architect, "아키텍처 분석")    ─┐
Task(quality-reviewer, "품질 분석")  ├─ 동시
Task(test-engineer, "테스트 분석")   ─┘

# 나쁜 예: 순차 실행
result1 = Task(architect, ...)    # 대기
result2 = Task(quality-reviewer, ...)  # 대기
result3 = Task(test-engineer, ...)     # 대기
```

## 멀티모델 위임

모든 역할은 기본적으로 Claude 에이전트(`Task()`)로 실행할 수 있다. 외부 CLI 워커(codex, gemini)는 CLI가 설치된 환경에서 특정 작업에 **우선 사용**하는 선호 옵션이다.

| 런타임 | 대상 | 호출 방식 | 적합한 작업 | 비고 |
|--------|------|----------|------------|------|
| Claude (기본) | opus | Task() | 매니징, 설계, 리뷰, 비판 | 항상 사용 가능 |
| Claude (기본) | sonnet | Task() | 구현, 디버깅, 검증 | 항상 사용 가능 |
| Claude (기본) | haiku | Task() | 탐색, 가벼운 조회 | 항상 사용 가능 |
| omc-teams (선호) | codex | omc_run_team_start | 상세 디버깅, 검증, 테스트 | CLI 설치 시 우선 사용 |
| omc-teams (선호) | gemini | omc_run_team_start | 프론트엔드 코드, UI/UX | CLI 설치 시 우선 사용 |

### 런타임 선택 기준

- **Claude (기본)**: 모든 역할에 사용 가능. 스킬 오케스트레이션과 긴밀한 연동이 필요한 작업, 또는 외부 CLI가 없는 환경에서 사용
- **omc-teams/codex (선호)**: codex CLI가 설치된 경우, 깊은 분석·꼼꼼한 검증·테스트 전략 수립처럼 정밀성이 중요한 작업에 우선 사용
- **omc-teams/gemini (선호)**: gemini CLI가 설치된 경우, 프론트엔드 구현·UI 컴포넌트·시각적 설계처럼 프론트엔드 전문성이 필요한 작업에 우선 사용

### Fallback

외부 CLI(codex, gemini)가 설치되지 않은 경우, `_shared/agent-routing.md`의 fallback 테이블을 따라 Claude 에이전트(`Task()`)로 대체한다.

## 예외

다음은 메인 에이전트가 직접 수행해도 된다:

- 단일 파일 읽기 (경로가 명확한 경우)
- 간단한 git 명령 (status, branch, log --oneline)
- 워크로그 업데이트 (마커 기반 편집)
- 사용자 질문/승인 처리
- 상태 파일 읽기/쓰기

## 절대 규칙

1. **파일 3개 이상 분석은 위임한다** — 메인 컨텍스트에 파일 내용을 쌓지 않는다
2. **위임 시 `_shared/agent-routing.md`를 참조한다** — 역할명만 사용하고, 런타임/대상을 직접 하드코딩하지 않는다
3. **독립 작업은 병렬로 호출한다** — 순차 실행으로 시간 낭비하지 않는다
4. **결과만 메인에 가져온다** — 서브에이전트의 중간 과정은 메인에 불필요
5. **런타임을 확인한다** — 외부 CLI(codex, gemini)가 설치되어 있고 작업이 선호 대상이면 `omc_run_team_start`를 우선 사용한다. CLI가 없으면 Claude `Task()`로 대체한다
